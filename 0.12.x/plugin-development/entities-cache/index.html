<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Article">
  

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>Plugin Development - Caching custom entities - v0.12.x | Kong - Open-Source API Management and Microservice Management</title>
  <meta name="description" content="Secure, Manage &amp; Extend your APIs or Microservices with plugins for authentication, logging, rate-limiting, transformations and more.">
  <meta name="author" content="KongHQ"/>
  <meta property="og:title" content="Open-Source API Management and Microservice Management"/>
  <meta property="og:site_name" content="Kong"/>
  <!-- use share link for facebook -->
  <meta property="og:url" content="https://docs.konghq.com"/>
  <meta property="og:description" content="Secure, Manage &amp; Extend your APIs or Microservices with plugins for authentication, logging, rate-limiting, transformations and more."/>
  <meta property="og:type" content="website"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:image" content="https://docs.konghq.com/assets/images/share.png"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:site" content="@thekonginc"/>
  <meta name="twitter:creator" content="@thekonginc"/>
  <meta name="twitter:url" content="https://docs.konghq.com"/>
  <meta name="twitter:description" content="Secure, Manage &amp; Extend your APIs or Microservices with plugins for authentication, logging, rate-limiting, transformations and more.">
  <meta name="twitter:image" content="https://docs.konghq.com/assets/images/share.png">
  <meta property="fb:admins" content="227304446"/>
  <meta property="fb:admins" content="576641408"/>
  <meta name="google-site-verification" content="CrU3zp02dNKTe8NSAipL4NCPkrIjDXG8fViTZ-MIzP4"/>

  <!-- New Relic -->
  <script>
/* eslint-disable */
window.NREUM||(NREUM={}),__nr_require=function(t,e,n){function r(n){if(!e[n]){var o=e[n]={exports:{}};t[n][0].call(o.exports,function(e){var o=t[n][1][e];return r(o||e)},o,o.exports)}return e[n].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<n.length;o++)r(n[o]);return r}({1:[function(t,e,n){function r(t){try{c.console&&console.log(t)}catch(e){}}var o,i=t("ee"),a=t(15),c={};try{o=localStorage.getItem("__nr_flags").split(","),console&&"function"==typeof console.log&&(c.console=!0,o.indexOf("dev")!==-1&&(c.dev=!0),o.indexOf("nr_dev")!==-1&&(c.nrDev=!0))}catch(s){}c.nrDev&&i.on("internal-error",function(t){r(t.stack)}),c.dev&&i.on("fn-err",function(t,e,n){r(n.stack)}),c.dev&&(r("NR AGENT IN DEVELOPMENT MODE"),r("flags: "+a(c,function(t,e){return t}).join(", ")))},{}],2:[function(t,e,n){function r(t,e,n,r,o){try{d?d-=1:i("err",[o||new UncaughtException(t,e,n)])}catch(c){try{i("ierr",[c,(new Date).getTime(),!0])}catch(s){}}return"function"==typeof f&&f.apply(this,a(arguments))}function UncaughtException(t,e,n){this.message=t||"Uncaught error with no additional information",this.sourceURL=e,this.line=n}function o(t){i("err",[t,(new Date).getTime()])}var i=t("handle"),a=t(16),c=t("ee"),s=t("loader"),f=window.onerror,u=!1,d=0;s.features.err=!0,t(1),window.onerror=r;try{throw new Error}catch(l){"stack"in l&&(t(8),t(7),"addEventListener"in window&&t(5),s.xhrWrappable&&t(9),u=!0)}c.on("fn-start",function(t,e,n){u&&(d+=1)}),c.on("fn-err",function(t,e,n){u&&(this.thrown=!0,o(n))}),c.on("fn-end",function(){u&&!this.thrown&&d>0&&(d-=1)}),c.on("internal-error",function(t){i("ierr",[t,(new Date).getTime(),!0])})},{}],3:[function(t,e,n){t("loader").features.ins=!0},{}],4:[function(t,e,n){function r(t){}if(window.performance&&window.performance.timing&&window.performance.getEntriesByType){var o=t("ee"),i=t("handle"),a=t(8),c=t(7),s="learResourceTimings",f="addEventListener",u="resourcetimingbufferfull",d="bstResource",l="resource",p="-start",h="-end",m="fn"+p,w="fn"+h,v="bstTimer",y="pushState";t("loader").features.stn=!0,t(6);var g=NREUM.o.EV;o.on(m,function(t,e){var n=t[0];n instanceof g&&(this.bstStart=Date.now())}),o.on(w,function(t,e){var n=t[0];n instanceof g&&i("bst",[n,e,this.bstStart,Date.now()])}),a.on(m,function(t,e,n){this.bstStart=Date.now(),this.bstType=n}),a.on(w,function(t,e){i(v,[e,this.bstStart,Date.now(),this.bstType])}),c.on(m,function(){this.bstStart=Date.now()}),c.on(w,function(t,e){i(v,[e,this.bstStart,Date.now(),"requestAnimationFrame"])}),o.on(y+p,function(t){this.time=Date.now(),this.startPath=location.pathname+location.hash}),o.on(y+h,function(t){i("bstHist",[location.pathname+location.hash,this.startPath,this.time])}),f in window.performance&&(window.performance["c"+s]?window.performance[f](u,function(t){i(d,[window.performance.getEntriesByType(l)]),window.performance["c"+s]()},!1):window.performance[f]("webkit"+u,function(t){i(d,[window.performance.getEntriesByType(l)]),window.performance["webkitC"+s]()},!1)),document[f]("scroll",r,{passive:!0}),document[f]("keypress",r,!1),document[f]("click",r,!1)}},{}],5:[function(t,e,n){function r(t){for(var e=t;e&&!e.hasOwnProperty(u);)e=Object.getPrototypeOf(e);e&&o(e)}function o(t){c.inPlace(t,[u,d],"-",i)}function i(t,e){return t[1]}var a=t("ee").get("events"),c=t(17)(a,!0),s=t("gos"),f=XMLHttpRequest,u="addEventListener",d="removeEventListener";e.exports=a,"getPrototypeOf"in Object?(r(document),r(window),r(f.prototype)):f.prototype.hasOwnProperty(u)&&(o(window),o(f.prototype)),a.on(u+"-start",function(t,e){var n=t[1],r=s(n,"nr@wrapped",function(){function t(){if("function"==typeof n.handleEvent)return n.handleEvent.apply(n,arguments)}var e={object:t,"function":n}[typeof n];return e?c(e,"fn-",null,e.name||"anonymous"):n});this.wrapped=t[1]=r}),a.on(d+"-start",function(t){t[1]=this.wrapped||t[1]})},{}],6:[function(t,e,n){var r=t("ee").get("history"),o=t(17)(r);e.exports=r,o.inPlace(window.history,["pushState","replaceState"],"-")},{}],7:[function(t,e,n){var r=t("ee").get("raf"),o=t(17)(r),i="equestAnimationFrame";e.exports=r,o.inPlace(window,["r"+i,"mozR"+i,"webkitR"+i,"msR"+i],"raf-"),r.on("raf-start",function(t){t[0]=o(t[0],"fn-")})},{}],8:[function(t,e,n){function r(t,e,n){t[0]=a(t[0],"fn-",null,n)}function o(t,e,n){this.method=n,this.timerDuration="number"==typeof t[1]?t[1]:0,t[0]=a(t[0],"fn-",this,n)}var i=t("ee").get("timer"),a=t(17)(i),c="setTimeout",s="setInterval",f="clearTimeout",u="-start",d="-";e.exports=i,a.inPlace(window,[c,"setImmediate"],c+d),a.inPlace(window,[s],s+d),a.inPlace(window,[f,"clearImmediate"],f+d),i.on(s+u,r),i.on(c+u,o)},{}],9:[function(t,e,n){function r(t,e){d.inPlace(e,["onreadystatechange"],"fn-",c)}function o(){var t=this,e=u.context(t);t.readyState>3&&!e.resolved&&(e.resolved=!0,u.emit("xhr-resolved",[],t)),d.inPlace(t,w,"fn-",c)}function i(t){v.push(t),h&&(g=-g,b.data=g)}function a(){for(var t=0;t<v.length;t++)r([],v[t]);v.length&&(v=[])}function c(t,e){return e}function s(t,e){for(var n in t)e[n]=t[n];return e}t(5);var f=t("ee"),u=f.get("xhr"),d=t(17)(u),l=NREUM.o,p=l.XHR,h=l.MO,m="readystatechange",w=["onload","onerror","onabort","onloadstart","onloadend","onprogress","ontimeout"],v=[];e.exports=u;var y=window.XMLHttpRequest=function(t){var e=new p(t);try{u.emit("new-xhr",[e],e),e.addEventListener(m,o,!1)}catch(n){try{u.emit("internal-error",[n])}catch(r){}}return e};if(s(p,y),y.prototype=p.prototype,d.inPlace(y.prototype,["open","send"],"-xhr-",c),u.on("send-xhr-start",function(t,e){r(t,e),i(e)}),u.on("open-xhr-start",r),h){var g=1,b=document.createTextNode(g);new h(a).observe(b,{characterData:!0})}else f.on("fn-end",function(t){t[0]&&t[0].type===m||a()})},{}],10:[function(t,e,n){function r(t){var e=this.params,n=this.metrics;if(!this.ended){this.ended=!0;for(var r=0;r<d;r++)t.removeEventListener(u[r],this.listener,!1);if(!e.aborted){if(n.duration=(new Date).getTime()-this.startTime,4===t.readyState){e.status=t.status;var i=o(t,this.lastSize);if(i&&(n.rxSize=i),this.sameOrigin){var a=t.getResponseHeader("X-NewRelic-App-Data");a&&(e.cat=a.split(", ").pop())}}else e.status=0;n.cbTime=this.cbTime,f.emit("xhr-done",[t],t),c("xhr",[e,n,this.startTime])}}}function o(t,e){var n=t.responseType;if("json"===n&&null!==e)return e;var r="arraybuffer"===n||"blob"===n||"json"===n?t.response:t.responseText;return h(r)}function i(t,e){var n=s(e),r=t.params;r.host=n.hostname+":"+n.port,r.pathname=n.pathname,t.sameOrigin=n.sameOrigin}var a=t("loader");if(a.xhrWrappable){var c=t("handle"),s=t(11),f=t("ee"),u=["load","error","abort","timeout"],d=u.length,l=t("id"),p=t(14),h=t(13),m=window.XMLHttpRequest;a.features.xhr=!0,t(9),f.on("new-xhr",function(t){var e=this;e.totalCbs=0,e.called=0,e.cbTime=0,e.end=r,e.ended=!1,e.xhrGuids={},e.lastSize=null,p&&(p>34||p<10)||window.opera||t.addEventListener("progress",function(t){e.lastSize=t.loaded},!1)}),f.on("open-xhr-start",function(t){this.params={method:t[0]},i(this,t[1]),this.metrics={}}),f.on("open-xhr-end",function(t,e){"loader_config"in NREUM&&"xpid"in NREUM.loader_config&&this.sameOrigin&&e.setRequestHeader("X-NewRelic-ID",NREUM.loader_config.xpid)}),f.on("send-xhr-start",function(t,e){var n=this.metrics,r=t[0],o=this;if(n&&r){var i=h(r);i&&(n.txSize=i)}this.startTime=(new Date).getTime(),this.listener=function(t){try{"abort"===t.type&&(o.params.aborted=!0),("load"!==t.type||o.called===o.totalCbs&&(o.onloadCalled||"function"!=typeof e.onload))&&o.end(e)}catch(n){try{f.emit("internal-error",[n])}catch(r){}}};for(var a=0;a<d;a++)e.addEventListener(u[a],this.listener,!1)}),f.on("xhr-cb-time",function(t,e,n){this.cbTime+=t,e?this.onloadCalled=!0:this.called+=1,this.called!==this.totalCbs||!this.onloadCalled&&"function"==typeof n.onload||this.end(n)}),f.on("xhr-load-added",function(t,e){var n=""+l(t)+!!e;this.xhrGuids&&!this.xhrGuids[n]&&(this.xhrGuids[n]=!0,this.totalCbs+=1)}),f.on("xhr-load-removed",function(t,e){var n=""+l(t)+!!e;this.xhrGuids&&this.xhrGuids[n]&&(delete this.xhrGuids[n],this.totalCbs-=1)}),f.on("addEventListener-end",function(t,e){e instanceof m&&"load"===t[0]&&f.emit("xhr-load-added",[t[1],t[2]],e)}),f.on("removeEventListener-end",function(t,e){e instanceof m&&"load"===t[0]&&f.emit("xhr-load-removed",[t[1],t[2]],e)}),f.on("fn-start",function(t,e,n){e instanceof m&&("onload"===n&&(this.onload=!0),("load"===(t[0]&&t[0].type)||this.onload)&&(this.xhrCbStart=(new Date).getTime()))}),f.on("fn-end",function(t,e){this.xhrCbStart&&f.emit("xhr-cb-time",[(new Date).getTime()-this.xhrCbStart,this.onload,e],e)})}},{}],11:[function(t,e,n){e.exports=function(t){var e=document.createElement("a"),n=window.location,r={};e.href=t,r.port=e.port;var o=e.href.split("://");!r.port&&o[1]&&(r.port=o[1].split("/")[0].split("@").pop().split(":")[1]),r.port&&"0"!==r.port||(r.port="https"===o[0]?"443":"80"),r.hostname=e.hostname||n.hostname,r.pathname=e.pathname,r.protocol=o[0],"/"!==r.pathname.charAt(0)&&(r.pathname="/"+r.pathname);var i=!e.protocol||":"===e.protocol||e.protocol===n.protocol,a=e.hostname===document.domain&&e.port===n.port;return r.sameOrigin=i&&(!e.hostname||a),r}},{}],12:[function(t,e,n){function r(){}function o(t,e,n){return function(){return i(t,[(new Date).getTime()].concat(c(arguments)),e?null:this,n),e?void 0:this}}var i=t("handle"),a=t(15),c=t(16),s=t("ee").get("tracer"),f=NREUM;"undefined"==typeof window.newrelic&&(newrelic=f);var u=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],d="api-",l=d+"ixn-";a(u,function(t,e){f[e]=o(d+e,!0,"api")}),f.addPageAction=o(d+"addPageAction",!0),f.setCurrentRouteName=o(d+"routeName",!0),e.exports=newrelic,f.interaction=function(){return(new r).get()};var p=r.prototype={createTracer:function(t,e){var n={},r=this,o="function"==typeof e;return i(l+"tracer",[Date.now(),t,n],r),function(){if(s.emit((o?"":"no-")+"fn-start",[Date.now(),r,o],n),o)try{return e.apply(this,arguments)}finally{s.emit("fn-end",[Date.now()],n)}}}};a("setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(t,e){p[e]=o(l+e)}),newrelic.noticeError=function(t){"string"==typeof t&&(t=new Error(t)),i("err",[t,(new Date).getTime()])}},{}],13:[function(t,e,n){e.exports=function(t){if("string"==typeof t&&t.length)return t.length;if("object"==typeof t){if("undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer&&t.byteLength)return t.byteLength;if("undefined"!=typeof Blob&&t instanceof Blob&&t.size)return t.size;if(!("undefined"!=typeof FormData&&t instanceof FormData))try{return JSON.stringify(t).length}catch(e){return}}}},{}],14:[function(t,e,n){var r=0,o=navigator.userAgent.match(/Firefox[\/\s](\d+\.\d+)/);o&&(r=+o[1]),e.exports=r},{}],15:[function(t,e,n){function r(t,e){var n=[],r="",i=0;for(r in t)o.call(t,r)&&(n[i]=e(r,t[r]),i+=1);return n}var o=Object.prototype.hasOwnProperty;e.exports=r},{}],16:[function(t,e,n){function r(t,e,n){e||(e=0),"undefined"==typeof n&&(n=t?t.length:0);for(var r=-1,o=n-e||0,i=Array(o<0?0:o);++r<o;)i[r]=t[e+r];return i}e.exports=r},{}],17:[function(t,e,n){function r(t){return!(t&&t instanceof Function&&t.apply&&!t[a])}var o=t("ee"),i=t(16),a="nr@original",c=Object.prototype.hasOwnProperty,s=!1;e.exports=function(t,e){function n(t,e,n,o){function nrWrapper(){var r,a,c,s;try{a=this,r=i(arguments),c="function"==typeof n?n(r,a):n||{}}catch(f){l([f,"",[r,a,o],c])}u(e+"start",[r,a,o],c);try{return s=t.apply(a,r)}catch(d){throw u(e+"err",[r,a,d],c),d}finally{u(e+"end",[r,a,s],c)}}return r(t)?t:(e||(e=""),nrWrapper[a]=t,d(t,nrWrapper),nrWrapper)}function f(t,e,o,i){o||(o="");var a,c,s,f="-"===o.charAt(0);for(s=0;s<e.length;s++)c=e[s],a=t[c],r(a)||(t[c]=n(a,f?c+o:o,i,c))}function u(n,r,o){if(!s||e){var i=s;s=!0;try{t.emit(n,r,o)}catch(a){l([a,n,r,o])}s=i}}function d(t,e){if(Object.defineProperty&&Object.keys)try{var n=Object.keys(t);return n.forEach(function(n){Object.defineProperty(e,n,{get:function(){return t[n]},set:function(e){return t[n]=e,e}})}),e}catch(r){l([r])}for(var o in t)c.call(t,o)&&(e[o]=t[o]);return e}function l(e){try{t.emit("internal-error",e)}catch(n){}}return t||(t=o),n.inPlace=f,n.flag=a,n}},{}],ee:[function(t,e,n){function r(){}function o(t){function e(t){return t&&t instanceof r?t:t?s(t,c,i):i()}function n(n,r,o){if(!l.aborted){t&&t(n,r,o);for(var i=e(o),a=h(n),c=a.length,s=0;s<c;s++)a[s].apply(i,r);var f=u[y[n]];return f&&f.push([g,n,r,i]),i}}function p(t,e){v[t]=h(t).concat(e)}function h(t){return v[t]||[]}function m(t){return d[t]=d[t]||o(n)}function w(t,e){f(t,function(t,n){e=e||"feature",y[n]=e,e in u||(u[e]=[])})}var v={},y={},g={on:p,emit:n,get:m,listeners:h,context:e,buffer:w,abort:a,aborted:!1};return g}function i(){return new r}function a(){(u.api||u.feature)&&(l.aborted=!0,u=l.backlog={})}var c="nr@context",s=t("gos"),f=t(15),u={},d={},l=e.exports=o();l.backlog=u},{}],gos:[function(t,e,n){function r(t,e,n){if(o.call(t,e))return t[e];var r=n();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(t,e,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return t[e]=r,r}var o=Object.prototype.hasOwnProperty;e.exports=r},{}],handle:[function(t,e,n){function r(t,e,n,r){o.buffer([t],r),o.emit(t,e,n)}var o=t("ee").get("handle");e.exports=r,r.ee=o},{}],id:[function(t,e,n){function r(t){var e=typeof t;return!t||"object"!==e&&"function"!==e?-1:t===window?0:a(t,i,function(){return o++})}var o=1,i="nr@id",a=t("gos");e.exports=r},{}],loader:[function(t,e,n){function r(){if(!b++){var t=g.info=NREUM.info,e=d.getElementsByTagName("script")[0];if(setTimeout(f.abort,3e4),!(t&&t.licenseKey&&t.applicationID&&e))return f.abort();s(v,function(e,n){t[e]||(t[e]=n)}),c("mark",["onload",a()],null,"api");var n=d.createElement("script");n.src="https://"+t.agent,e.parentNode.insertBefore(n,e)}}function o(){"complete"===d.readyState&&i()}function i(){c("mark",["domContent",a()],null,"api")}function a(){return(new Date).getTime()}var c=t("handle"),s=t(15),f=t("ee"),u=window,d=u.document,l="addEventListener",p="attachEvent",h=u.XMLHttpRequest,m=h&&h.prototype;NREUM.o={ST:setTimeout,CT:clearTimeout,XHR:h,REQ:u.Request,EV:u.Event,PR:u.Promise,MO:u.MutationObserver},t(12);var w=""+location,v={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-1016.min.js"},y=h&&m&&m[l]&&!/CriOS/.test(navigator.userAgent),g=e.exports={offset:a(),origin:w,features:{},xhrWrappable:y};d[l]?(d[l]("DOMContentLoaded",i,!1),u[l]("load",r,!1)):(d[p]("onreadystatechange",o),u[p]("onload",r)),c("mark",["firstbyte",a()],null,"api");var b=0},{}]},{},["loader",2,10,4,3]);
;NREUM.info={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",licenseKey:"13e44ec848",applicationID:"46444088",sa:1}
</script>


  <!-- FullStory -->
  <!-- <script>
/* eslint-disable */
window['_fs_debug'] = false;
window['_fs_host'] = 'fullstory.com';
window['_fs_org'] = '7JS2S';
window['_fs_namespace'] = 'FS';
(function(m,n,e,t,l,o,g,y){
    if (e in m) {if(m.console && m.console.log) { m.console.log('FullStory namespace conflict. Please set window["_fs_namespace"].');} return;}
    g=m[e]=function(a,b){g.q?g.q.push([a,b]):g._api(a,b);};g.q=[];
    o=n.createElement(t);o.async=1;o.src='https://'+_fs_host+'/s/fs.js';
    y=n.getElementsByTagName(t)[0];y.parentNode.insertBefore(o,y);
    g.identify=function(i,v){g(l,{uid:i});if(v)g(l,v)};g.setUserVars=function(v){g(l,v)};g.event=function(i,v){g('event',{n:i,p:v})};
    g.shutdown=function(){g("rec",!1)};g.restart=function(){g("rec",!0)};
    g.consent=function(a){g("consent",!arguments.length||a)};
    g.identifyAccount=function(i,v){o='account';v=v||{};v.acctId=i;g(o,v)};
    g.clearUserCookie=function(){};
})(window,document,window['_fs_namespace'],'script','user');
</script>
 -->

  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "name": "KongHQ",
      "url": "https://docs.konghq.com",
      "logo": "https://docs.konghq.com/assets/images/logo.png",
      "sameAs": [
        "https://www.facebook.com/konginc",
        "https://twitter.com/thekonginc",
        "https://plus.google.com/+mashape"
      ]
    }
  </script>

  <!-- Preload assets -->
  <link rel="dns-prefetch" href="//cloud.typography.com">
  <link rel="dns-prefetch" href="//dev.visualwebsiteoptimizer.com">
  <link rel="dns-prefetch" href="//cdn.segment.com">
  <!-- ##gulp-resource-hints## -->

  <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
  <link rel="stylesheet" href="/assets/styles.css?v=1537994384"/>
  
</head>

<!-- Kong Cookie Policy -->
<div class="cookie-policy-container">
  <p>In order to give you better service we use cookies. By continuing to use our website, you agree to the use of cookies as described in our <a href=" https://konghq.com/cookie-policy/">Cookie Policy</a>
  <button class="cookie-policy-accept btn button" type="submit">I Agree</button>
</div>



  <body id=""  data-spy="scroll" data-target="#scroll-sidebar" data-offset="350">
    <header class="site-header fixed-top">
  <div class="enterprise">

    <!-- Kong Summit Announcement Banner -->

    <div class="container">
      <nav class="enterprise-sites one-half column">
        <ul>
          <li>
            <a href="https://konghq.com/kong-enterprise-edition">Enterprise</a>
          </li>
          <li>
            <a href="https://konghq.com/kong-community-edition">Kong API Gateway</a>
          </li>
        </ul>
      </nav>
      <nav class="enterprise-contact one-half column">
        <ul>
          <li>
            <a href="https://support.konghq.com/">Support</a>
          </li>
          <li>
            <a href="https://konghq.com/request-demo">Request Demo</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  <!-- .enterprise -->
  <div class="navbar">
    <div class="container">
      <a href="https://konghq.com" class="navbar-brand">
        <img src="/assets/images/Kogo.svg" alt="Kong">
      </a>
      <iframe class="header-star" src="https://ghbtns.com/github-btn.html?user=Kong&amp;repo=kong&amp;type=star" frameborder="0"
        scrolling="0" width="55" height="20"></iframe>
      <button data-toggle="collapse" data-target="#navbar" aria-expanded="true" aria-controls="navbar" class="navbar-toggle">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <nav id="navbar" class="navbar-nav">
        <ul>
          <li>
            <a href="/" class="active">Docs</a>
          </li>
          <li>
            <a href="https://konghq.com/about-kong-inc/">About</a>
          </li>
          <li>
            <a href="/hub/">Hub</a>
          </li>
          <li>
            <a href="https://konghq.com/community-resources/">Community</a>
          </li>
          <li>
            <a href="https://konghq.com/kong-enterprise-edition/">Enterprise</a>
          </li>
          <li>
            <a href="https://github.com/Kong/kong" target="_blank">GitHub</a>
          </li>
          <li class="hidden-lg">
            <a href="https://support.konghq.com/">Support</a>
          </li>
          <li>
            <a href="https://konghq.com/install" class="button button-dark" data-analytics='{"event": "Clicked download", "type": "button", "location": "header"}'>Installation</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  <!-- .navbar -->
</header>


    <div class="page ">
  <header class="page-header">
    <div class="container">
        <div class="edit-this-page">
            <a target="_blank" href="https://github.com/Kong/docs.konghq.com/tree/master/app/0.12.x/plugin-development/entities-cache.md"><i class="fa fa-github"></i> Edit this Page</a>
          </div>
      <nav class="docs-navigation">
        <a href="/"  class="active">Kong Community Edition (CE)</a>
        <a href="/enterprise" >Kong Enterprise Edition (EE)</a>
      </nav>
      <div class="page-header-icon">
        <img src="/assets/images/icons/icn-documentation-ce.svg" alt="Documentation" />
      </div>
      <div class="page-header-title">
        <p>Documentation</p>
        
        
        <div class="page-header-section-title">
            
            Community Edition (0.12.x)
        </div>
        
      </div>

      
        <div class="dropdown page-header-right">
          <button class="page-header-btn" id="version-dropdown" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Version 0.12.x
            
            <span class="caret"></span>
          </button>

          <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="version-dropdown">
            
              
                <li>
                  <a href="/0.14.x">
                    0.14.x
                  </a>
                </li>
              
            
              
                <li>
                  <a href="/0.13.x">
                    0.13.x
                  </a>
                </li>
              
            
              
            
              
                <li>
                  <a href="/0.11.x">
                    0.11.x
                  </a>
                </li>
              
            
              
                <li>
                  <a href="/0.10.x">
                    0.10.x
                  </a>
                </li>
              
            
              
                <li>
                  <a href="/0.9.x">
                    0.9.x
                  </a>
                </li>
              
            
              
                <li>
                  <a href="/0.8.x">
                    0.8.x
                  </a>
                </li>
              
            
              
                <li>
                  <a href="/0.7.x">
                    0.7.x
                  </a>
                </li>
              
            
              
                <li>
                  <a href="/0.6.x">
                    0.6.x
                  </a>
                </li>
              
            
              
                <li>
                  <a href="/0.5.x">
                    0.5.x
                  </a>
                </li>
              
            
              
                <li>
                  <a href="/0.4.x">
                    0.4.x
                  </a>
                </li>
              
            
              
                <li>
                  <a href="/0.3.x">
                    0.3.x
                  </a>
                </li>
              
            
              
                <li>
                  <a href="/0.2.x">
                    0.2.x
                  </a>
                </li>
              
            
          </ul>
          
          <div id="getkong-algolia-search" class="search-input">
            <i class="fa fa-search"></i>
            <input type="text" placeholder="Search" id="getkong-algolia-search-input" />
          </div>
          
        </div>
      
    </div>
  </header>

  <div class="container">
    <aside class="page-navigation">
      

      

      
      <nav>
        
          <h5>Getting Started</h5>
        
        <ul>
          
          
          <li>
            <a href="/0.12.x/getting-started/introduction" >
              Introduction
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/getting-started/quickstart" >
              Five-minute quickstart
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/getting-started/adding-your-api" >
              Adding your API
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/getting-started/enabling-plugins" >
              Enabling Plugins
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/getting-started/adding-consumers" >
              Adding Consumers
            </a>
            
          </li>
          
        </ul>
      </nav>
      
      <nav>
        
          <h5>Guides &amp; References</h5>
        
        <ul>
          
          
          <li>
            <a href="/0.12.x/configuration" >
              Configuration reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/cli" >
              CLI reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/proxy" >
              Proxy reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/auth" >
              Authentication reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/loadbalancing" >
              Load balancing reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/health-checks-circuit-breakers" >
              Health checks and circuit breakers reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/clustering" >
              Clustering reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/network" >
              Network &amp; Firewall
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/lua-reference/" >
              Public Lua API reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/secure-admin-api" >
              Securing the Admin API
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/plugin-development" >
              Plugin Development Guide
            </a>
            
            <ul>
              
              
              <li>
                <a href="/0.12.x/plugin-development" >Introduction</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/plugin-development/file-structure" >File structure</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/plugin-development/custom-logic" >Implement custom logic</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/plugin-development/plugin-configuration" >Plugin configuration</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/plugin-development/access-the-datastore" >Access the datastore</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/plugin-development/custom-entities" >Store custom entities</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/plugin-development/entities-cache" class="active">Caching custom entities</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/plugin-development/admin-api" >Extending the Admin API</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/plugin-development/tests" >Writing tests</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/plugin-development/distribution" >(un)Install your plugin</a>
              </li>
              
            </ul>
            
          </li>
          
        </ul>
      </nav>
      
      <nav>
        
          <a href="/0.12.x/admin-api/"><h5>Admin API</h5></a>
        
        <ul>
          
          
          <li>
            <a href="/0.12.x/admin-api/#supported-content-types" >
              Supported Content Types
            </a>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/admin-api/#information-routes" >
              Information routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/0.12.x/admin-api/#retrieve-node-information" >Retrieve node information</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#retrieve-node-status" >Retrieve node status</a>
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/admin-api/#api-object" >
              API Object routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/0.12.x/admin-api/#add-api" >Add API</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#retrieve-api" >Retrieve API</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#list-apis" >List APIs</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#update-api" >Update API</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#update-or-create-api" >Update or create API</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#delete-api" >Delete API</a>
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/admin-api/#consumer-object" >
              Consumer Object routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/0.12.x/admin-api/#create-consumer" >Create Consumer</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#retrieve-consumer" >Retrieve Consumer</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#list-consumers" >List Consumers</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#update-consumer" >Update Consumer</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#update-or-create-consumer" >Update or create Consumer</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#delete-consumer" >Delete Consumer</a>
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/admin-api/#plugin-object" >
              Plugin Object routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/0.12.x/admin-api/#add-plugin" >Add Plugin</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#retrieve-plugin" >Retrieve Plugin</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#list-all-plugins" >List all Plugins</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#list-plugins-per-api" >List Plugins per API</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#update-plugin" >Update Plugin</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#update-or-add-plugin" >Update or Add Plugin</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#delete-plugin" >Delete Plugin</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#retrieve-enabled-plugins" >Retrieve Enabled Plugins</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#retrieve-plugin-schema" >Retrieve Plugin Schema</a>
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/admin-api/#certificate-object" >
              Certificate Object routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/0.12.x/admin-api/#add-certificate" >Add Certificate</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#retrieve-certificate" >Retrieve Certificate</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#list-certificates" >List Certificates</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#update-certificate" >Update Certificate</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#update-or-create-certificate" >Update or Create Certificate</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#delete-certificate" >Delete Certificate</a>
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/admin-api/#sni-objects" >
              SNI Object routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/0.12.x/admin-api/#add-sni" >Add SNI</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#retrieve-sni" >Retrieve SNI</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#list-snis" >List SNIs</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#update-sni" >Update SNI</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#update-or-create-sni" >Update or Create SNI</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#delete-sni" >Delete SNI</a>
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/admin-api/#upstream-objects" >
              Upstream Object routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/0.12.x/admin-api/#add-upstream" >Add Upstream</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#retrieve-upstream" >Retrieve Upstream</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#list-upstreams" >List all Upstreams</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#update-upstream" >Update Upstream</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#update-or-create-upstream" >Update or create Upstream</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#delete-upstream" >Delete Upstream</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#show-upstream-health-for-node" >Show Upstream health for node</a>
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/0.12.x/admin-api/#target-object" >
              Target Object routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/0.12.x/admin-api/#add-target" >Add Target</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#list-targets" >List Targets</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#list-all-targets" >List All Targets</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#delete-target" >Delete Target</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#set-target-as-healthy" >Set Target as Healthy</a>
              </li>
              
              
              <li>
                <a href="/0.12.x/admin-api/#set-target-as-unhealthy" >Set Target as Unhealthy</a>
              </li>
              
            </ul>
            
          </li>
          
        </ul>
      </nav>
      
    </aside>

    <div class="page-content-container" id="documentation">
      <div class="page-content">
        <div class="content">
          
            <div class="alert alert-ee">
              Maybe you were looking for the <a href="/enterprise"><strong>Enterprise Edition (EE) Documentation</strong></a> instead?
            </div>
          
          
          <div class="alert alert-warning">
            <strong>Careful!</strong> You are browsing documentation for an outdated version of Kong. Go <a href="/latest">here</a> to browse the documentation for the latest version.
          </div>
          

          <h1 id="plugin-development-caching-custom-entities">Plugin Development - Caching custom entities</h1>

<h4 id="modules">Modules</h4>
<div class="highlight"><pre><code class="language-" data-lang="">"kong.plugins.&lt;plugin_name&gt;.daos"
"kong.plugins.&lt;plugin_name&gt;.hooks"
</code></pre></div>
<hr>

<p>Your plugin may need to frequently access custom entities (explained in the
<a href="/0.12.x/plugin-development/custom-entities/">previous chapter</a>) on every request and/or response.
Usually, loading them once and caching them in-memory dramatically improves
the performance while making sure the datastore is not stressed with an
increased load.</p>

<p>Think of an api-key authentication plugin that needs to validate the api-key on
every request, thus loading the custom credential object from the datastore on
every request. When the client provides an api-key along with the request,
normally you would query the datastore to check if that key exists, and then
either block the request or retrieve the Consumer ID to identify the user. This
would happen on every request, and it would be very inefficient:</p>

<ul>
<li>Querying the datastore adds latency on every request, making the request
processing slower.</li>
<li>The datastore would also be affected by an increase of load, potentially
crashing or slowing down, which in turn would affect every Kong
node.</li>
</ul>

<p>To avoid querying the datastore every time, we can cache custom entities
in-memory on the node, so that frequent entity lookups don&#39;t trigger a
datastore query every time (only the first time), but happen in-memory, which
is much faster and reliable that querying it from the datastore (especially
under heavy load).</p>

<hr>

<h3 id="caching-custom-entities">Caching custom entities</h3>

<p>Once you have defined your custom entities, you can cache them in-memory in
your code by using the <code>singletons.cache</code> module provided by Kong:</p>
<div class="highlight"><pre><code class="language-" data-lang="">local singletons = require "kong.singletons"
local cache = singletons.cache
</code></pre></div>
<p>There are 2 levels of cache:</p>

<ol>
<li>L1: Lua memory cache - local to an nginx worker
This can hold any type of Lua value.</li>
<li>L2: Shared memory cache (SHM) - local to an nginx node, but shared between
all workers. This can only hold scalar values, and hence requires
(de)serialization.</li>
</ol>

<p>When data is fetched from the database, it will be stored in both caches. Now
if the same worker process requests the data again, it will retrieve the
previously-deserialized data from the Lua memory cache. If a different
worker within the same nginx node requests that data, it will find the data
in the SHM, deserialize it (and store it in its own Lua memory cache) and
then return it.</p>

<p>This module exposes the following functions:</p>

<table><thead>
<tr>
<th>Function name</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code>value, err = cache:get(key, opts?, cb, ...)</code></td>
<td>Retrieves the value from the cache. If the cache does not have value (miss), invokes <code>cb</code> in protected mode. <code>cb</code> must return one (and only one) value that will be cached. It <em>can</em> throw errors, as those will be caught and properly logged by Kong, at the <code>ngx.ERR</code> level. This function <strong>does</strong> cache negative results (<code>nil</code>). As such, one must rely on its second argument <code>err</code> when checking for errors.</td>
</tr>
<tr>
<td><code>ttl, err, value = cache:probe(key)</code></td>
<td>Checks if a value is cached. If it is, returns its remaining TTL. It not, returns <code>nil</code>. The value being cached can also be a negative caching. The third return value is the value being cached itself.</td>
</tr>
<tr>
<td><code>cache:invalidate_local(key)</code></td>
<td>Evicts a value from the node&#39;s cache.</td>
</tr>
<tr>
<td><code>cache:invalidate(key)</code></td>
<td>Evicts a value from the node&#39;s cache <strong>and</strong> propagates the eviction events to all other nodes in the cluster.</td>
</tr>
<tr>
<td><code>cache:purge()</code></td>
<td>Evicts <strong>all</strong> values from the node&#39;s cache.</td>
</tr>
</tbody></table>

<p>Bringing back our authentication plugin example, to lookup a credential with a
specific api-key, we would write something like:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="c1">-- access.lua</span>
<span class="kd">local</span> <span class="n">singletons</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"kong.singletons"</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">load_entity_key</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
  <span class="c1">-- IMPORTANT: the callback is executed inside a lock, hence we cannot terminate</span>
  <span class="c1">-- a request here, we MUST always return.</span>
  <span class="kd">local</span> <span class="n">apikeys</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">dao</span><span class="p">.</span><span class="n">apikeys</span><span class="p">:</span><span class="n">find_all</span><span class="p">({</span><span class="n">key</span> <span class="o">=</span> <span class="n">api_key</span><span class="p">})</span> <span class="c1">-- Lookup in the datastore</span>
  <span class="k">if</span> <span class="n">err</span> <span class="k">then</span>
    <span class="nb">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="c1">-- caught by kong.cache and logged</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">apikeys</span> <span class="k">then</span>
    <span class="k">return</span> <span class="kc">nil</span> <span class="c1">-- nothing was found (cached for `neg_ttl`)</span>
  <span class="k">end</span>

  <span class="c1">-- assuming the key was unique, we always only have 1 value...</span>
  <span class="k">return</span> <span class="n">apikeys</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1">-- cache the credential (cached for `ttl`)</span>
<span class="k">end</span>

<span class="c1">-- retrieve the apikey from the request querystring</span>
<span class="kd">local</span> <span class="n">apikey</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">get_uri_args</span><span class="p">().</span><span class="n">apikey</span>

<span class="c1">-- We are using cache.get to first check if the apikey has been already</span>
<span class="c1">-- stored into the in-memory cache at the key: "apikeys." .. apikey</span>
<span class="c1">-- If it's not, then we lookup the datastore and return the credential</span>
<span class="c1">-- object. Internally cache.get will save the value in-memory, and then</span>
<span class="c1">-- return the credential.</span>
<span class="kd">local</span> <span class="n">credential</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cache</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">"apikeys."</span> <span class="o">..</span> <span class="n">apikey</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span>
                                  <span class="n">load_entity_key</span><span class="p">,</span> <span class="n">apikey</span><span class="p">)</span>
<span class="k">if</span> <span class="n">err</span> <span class="k">then</span>
  <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">HTTP_INTERNAL_SERVER_ERROR</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">credential</span> <span class="k">then</span>
  <span class="c1">-- no credentials in cache nor datastore</span>
  <span class="k">return</span> <span class="n">responses</span><span class="p">.</span><span class="n">send_HTTP_FORBIDDEN</span><span class="p">(</span><span class="s2">"Invalid authentication credentials"</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1">-- set an upstream header if the credential exists and is valid</span>
<span class="n">ngx</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"X-API-Key"</span><span class="p">,</span> <span class="n">credential</span><span class="p">.</span><span class="n">apikey</span><span class="p">)</span>
</code></pre></div>
<p>With the above mechanism in place, once a Consumer has made a request with
their API key, the cache will be considered warm and subsequent requests
won&#39;t result in a database query.</p>

<h4 id="updating-or-deleting-a-custom-entity">Updating or deleting a custom entity</h4>

<p>Every time a cached custom entity is updated or deleted in the datastore (i.e.
using the Admin API), it creates an inconsistency between the data in
the datastore, and the data cached in the Kong nodes&#39; memory. To avoid this
inconsistency, we need to evict the cached entity from the in-memory store and
force Kong to request it again from the datastore. We refer to this process as
cache invalidation.</p>

<hr>

<h3 id="cache-invalidation-for-your-entities">Cache invalidation for your entities</h3>

<p>If you wish that your cached entities be invalidated upon a CRUD operation
rather than having to wait for them to reach their TTL, you have to follow
a few steps. This process can be automated since 0.11.0 for most entities,
but manually subscribing to some CRUD events might be required to invalidate
some entities with more complex relationships.</p>

<h4 id="automatic-cache-invalidation">Automatic cache invalidation</h4>

<p>Cache invalidation can be provided out of the box for your entities if you
rely on the <code>cache_key</code> property of your entity&#39;s schema. For example, in the
following schema:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">SCHEMA</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">primary_key</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"id"</span> <span class="p">},</span>
  <span class="n">table</span> <span class="o">=</span> <span class="s2">"keyauth_credentials"</span><span class="p">,</span>
  <span class="n">cache_key</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"key"</span> <span class="p">},</span> <span class="c1">-- cache key for this entity</span>
  <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">id</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">type</span> <span class="o">=</span> <span class="s2">"id"</span> <span class="p">},</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">type</span> <span class="o">=</span> <span class="s2">"timestamp"</span><span class="p">,</span> <span class="n">immutable</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="n">consumer_id</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">type</span> <span class="o">=</span> <span class="s2">"id"</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">foreign</span> <span class="o">=</span> <span class="s2">"consumers:id"</span><span class="p">},</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">type</span> <span class="o">=</span> <span class="s2">"string"</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">return</span> <span class="p">{</span> <span class="n">keyauth_credentials</span> <span class="o">=</span> <span class="n">SCHEMA</span> <span class="p">}</span>
</code></pre></div>
<p>We can see that we declare the cache key of this API key entity to be its
<code>key</code> attribute. We use <code>key</code> here because it has a unique constraints
applied to it. Hence, the attributes added to <code>cache_key</code> should result in
a unique combination, so that no two entities could yield the same cache key.</p>

<p>Adding this value allows you to use the following function on the DAO of that
entity:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="n">cache_key</span> <span class="o">=</span> <span class="n">dao</span><span class="p">:</span><span class="n">cache_key</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">arg3</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</code></pre></div>
<p>Where the arguments must be the attributes specified in your schema&#39;s
<code>cache_key</code> property, in the order they were specified. This function then
computes a string value <code>cache_key</code> that is ensured to be unique.</p>

<p>For example, if we were to generate the cache_key of an API key:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">cache_key</span> <span class="o">=</span> <span class="n">singletons</span><span class="p">.</span><span class="n">dao</span><span class="p">.</span><span class="n">keyauth_credentials</span><span class="p">:</span><span class="n">cache_key</span><span class="p">(</span><span class="s2">"abcd"</span><span class="p">)</span>
</code></pre></div>
<p>This would produce a cache_key for the API key <code>&quot;abcd&quot;</code> (retrieved from one
of the query&#39;s arguments) that we can the use to retrieve the key from the
cache (or fetch from the database if the cache is a miss):</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">apikey</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">get_uri_args</span><span class="p">().</span><span class="n">apikey</span>
<span class="kd">local</span> <span class="n">cache_key</span> <span class="o">=</span> <span class="n">singletons</span><span class="p">.</span><span class="n">dao</span><span class="p">.</span><span class="n">keyauth_credentials</span><span class="p">:</span><span class="n">cache_key</span><span class="p">(</span><span class="n">apikey</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">credential</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cache</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">load_entity_key</span><span class="p">,</span> <span class="n">apikey</span><span class="p">)</span>
<span class="k">if</span> <span class="n">err</span> <span class="k">then</span>
  <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">HTTP_INTERNAL_SERVER_ERROR</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1">-- do something with the credential</span>
</code></pre></div>
<p>If the <code>cache_key</code> is generated like so and specified in an entity&#39;s schema,
cache invalidation will be an automatic process: every CRUD operation that
affects this API key will be make Kong generate the affected <code>cache_key</code>, and
broadcast it to all of the other nodes on the cluster so they can evict
that particular value from their cache, and fetch the fresh value from the
datastore on the next request.</p>

<p>When a parent entity is receiving a CRUD operation (e.g. the Consumer owning
this API key, as per our schema&#39;s <code>consumer_id</code> attribute), Kong performs the
cache invalidation mechanism for both the parent and the child entity.</p>

<p><strong>Note</strong>: Be aware of the negative caching that Kong provides. In the above
example, if there is no API key in the datastore for a given key, the cache
module will store the miss just as if it was a hit. This means that a
&quot;Create&quot; event (one that would create an API key with this given key) is also
propagated by Kong so that all nodes that stored the miss can evict it, and
properly fetch the newly created API key from the datastore.</p>

<p>See the <a href="/0.12.x/clustering/">Clustering Guide</a> to ensure
that you have properly configured your cluster for such invalidation events.</p>

<h4 id="manual-cache-invalidation">Manual cache invalidation</h4>

<p>In some cases, the <code>cache_key</code> property of an entity&#39;s schema is not flexible
enough, and one must manually invalidate its cache. Reasons for this could be
that the plugin is not defining a relationship with another entity via the
traditional <code>foreign = &quot;parent_entity:parent_attribute&quot;</code> syntax, or because
it is not using the <code>cache_key</code> method from its DAO, or even because it is
somehow abusing the caching mechanism.</p>

<p>In those cases, you can manually setup your own subscriber to the same
invalidation channels Kong is listening to, and perform your own, custom
invalidation work. This process is similar to the old <code>hooks.lua</code> module that
was required in &lt; 0.11.0 for cache invalidations.</p>

<p>To listen on invalidation channels inside of Kong, implement the following in
your plugin&#39;s <code>init_worker</code> handler:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="k">function</span> <span class="nf">MyCustomHandler</span><span class="p">:</span><span class="n">init_worker</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">worker_events</span> <span class="o">=</span> <span class="n">singletons</span><span class="p">.</span><span class="n">worker_events</span>

  <span class="c1">-- listen to all CRUD operations made on Consumers</span>
  <span class="n">worker_events</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

  <span class="k">end</span><span class="p">,</span> <span class="s2">"crud"</span><span class="p">,</span> <span class="s2">"consumers"</span><span class="p">)</span>

  <span class="c1">-- or, listen to a specific CRUD operation only</span>
  <span class="n">worker_events</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">operation</span><span class="p">)</span>  <span class="c1">-- "update"</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">old_entity</span><span class="p">)</span> <span class="c1">-- old entity table (only for "update")</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">entity</span><span class="p">)</span>     <span class="c1">-- new entity table</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">schema</span><span class="p">)</span>     <span class="c1">-- entity's schema</span>
  <span class="k">end</span><span class="p">,</span> <span class="s2">"crud"</span><span class="p">,</span> <span class="s2">"consumers:update"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>Once the above listeners are in place for the desired entities, you can perform
manual invalidations of any entity that your plugin has cached as you wish so.
For instance:</p>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="n">singletons</span><span class="p">.</span><span class="n">worker_events</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">"delete"</span> <span class="k">then</span>
    <span class="kd">local</span> <span class="n">cache_key</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">entity</span><span class="p">.</span><span class="n">id</span>
    <span class="n">singletons</span><span class="p">.</span><span class="n">cache</span><span class="p">:</span><span class="n">invalidate</span><span class="p">(</span><span class="s2">"prefix:"</span> <span class="o">..</span> <span class="n">cache_key</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">,</span> <span class="s2">"crud"</span><span class="p">,</span> <span class="s2">"consumers"</span><span class="p">)</span>
</code></pre></div>
<h3 id="extending-the-admin-api">Extending the Admin API</h3>

<p>As you are probably aware, the <a href="/0.12.x/admin-api/">Admin API</a> is where Kong users communicate with
Kong to setup their APIs and plugins. It is likely that they also need to be
able to interact with the custom entities you implemented for your plugin (for
example, creating and deleting API keys). The way you would do this is by
extending the Admin API, which we will detail in the next chapter: <a href="/0.12.x/plugin-development/admin-api/">Extending
the Admin API</a>.</p>

<hr>

<p>Next: <a href="/0.12.x/plugin-development/admin-api/">Extending the Admin API &rsaquo;</a></p>


        </div>
      </div>
    </div>
  </div>
</div>
<style>
  @media (max-width: 768px) {
    .algolia-docsearch-suggestion--subcategory-column{
      display: none !important;
    }
  }
</style>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
    apiKey: '691286ef280379144076a4f8df47a1d1',
    indexName: 'getkong',
    inputSelector: '#getkong-algolia-search-input',
    algoliaOptions: {
      hitsPerPage: 5,
      'facetFilters': ["version: 0.12.x"]
    },
    // Override selected event to allow for local environment navigation
    handleSelected: function (input, event, suggestion) {
      input.setVal('');
      window.location.href = window.location.protocol + "//" + window.location.host + suggestion.url.split("docs.konghq.com")[1]
    }
    // ,debug: true // Set debug to true if you want to inspect the dropdown
  });
</script>



    
  <section class="section subscribe-section" id="newsletter">
  <div class="container">
    <header class="section-header">
      <h4>Keep up with the latest features</h4>
    </header>

    <div class="row">
      <div class="one-half column offset-by-three">
        <noscript>
          <iframe id="newsletter-iframe" src="https://go.pardot.com/l/392112/2017-08-16/b2qn8v" width="100%" height="100" type="text/html"
            frameborder="0" allowTransparency="true" style="border: 0"></iframe>
        </noscript>
        <script type="text/javascript">
          var form = 'https://go.pardot.com/l/392112/2017-08-16/b2qn8v';
          var params = window.location.search;
          var thisScript = document.scripts[document.scripts.length - 1];
          var iframe = document.createElement('iframe');

          iframe.setAttribute('src', form + params);
          iframe.setAttribute('width', '100%');
          iframe.setAttribute('height', 100);
          iframe.setAttribute('type', 'text/html');
          iframe.setAttribute('frameborder', 0);
          iframe.setAttribute('allowTransparency', 'true');
          iframe.setAttribute('id', 'newsletter-iframe');
          iframe.style.border = '0';

          thisScript.parentElement.replaceChild(iframe, thisScript);
        </script>
      </div>
    </div>
  </div>
</section>



<footer class="marketing-footer--light-gray">
  <section>
    <ul>
      <li class="logo-wrapper">
        <div class="logo">
          <img src="/assets/images/kong-blue.png" alt="Kong Inc">
        </div>
      </li>
      <li>
        <nav>
          <h4>Company</h4>
          <ul>
            <li><a href="https://konghq.com/about-kong-inc/">About</a></li>
            <li><a href="https://konghq.com/investors/">Investors</a></li>
            <li><a href="http://konghq.com/blog/">Blog</a></li>
            <li><a href="https://konghq.com/jobs/">Jobs</a></li>
            <li><a href="https://konghq.com/contact/">Contact</a></li>
            <li><a href="https://support.konghq.com">Support</a></li>
          </ul>
        </nav>
      </li>
      <li>
        <nav>
          <h4>Products</h4>
          <ul>
            <li><a href="https://docs.konghq.com/">Kong</a></li>
            <li><a href="https://konghq.com/api-dev-portal/">Dev Portal</a></li>
            <li><a href="https://konghq.com/api-analytics/">API Analytics</a></li>
            <li><a href="https://konghq.com/kong-enterprise-edition/">Enterprise</a></li>
          </ul>
        </nav>
      </li>
      <li>
        <nav>
          <h4>Open Source</h4>
          <ul>
            <li><a href="http://mockbin.org/">Mockbin</a></li>
            <li><a href="http://apiembed.com/">API Embed</a></li>
            <li><a href="http://unirest.io/">Unirest</a></li>
            <li><a href="http://guardianjs.com/">Guardian JS</a></li>
            <li><a href="http://oauthbible.com/">OAuth Bible</a></li>
          </ul>
        </nav>
      </li>
      <li>
        <nav>
          <h4>Legal</h4>
          <ul>
            <li><a href="https://konghq.com/terms/">Terms of Service</a></li>
            <li><a href="https://konghq.com/privacy/">Privacy Policy</a></li>
          </ul>
        </nav>
      </li>
    </ul>
  </section>

  <section class="legal">
    <ul>
      <li>
        <span class="mashape-footer-content">&copy; Kong Inc. 2018</span>
      </li>
      <li>
        <div class="social-link">
          <a href="https://github.com/Kong" title="Github"><i aria-label="Github" class="fa fa-github" aria-hidden="true"></i></a></div>
        <div class="social-link">
          <a href="https://www.facebook.com/konghq/" title="Facebook"><i aria-label="Facebook" class="fa fa-facebook-official" aria-hidden="true"></i></a></div>
        <div class="social-link">
          <a href="https://www.meetup.com/topics/kong/all/" title="Meetup"><img aria-label="Meetup" alt="Meetup" src="/assets/images/footer/icn-meetup-black.svg"></a>
        </div>
        <div class="social-link">
          <a href="https://twitter.com/thekonginc" title="Twitter"><i aria-label="Twitter" class="fa fa-twitter" aria-hidden="true"></i></a>
        </div>
      </li>
    </ul>
  </section>
</footer>

    <script>
  var anchorForId = function (id) {
    var anchor = document.createElement("a");
    anchor.className = "header-link";
    anchor.href      = "#" + id;
    anchor.innerHTML = "<span class=\"sr-only\">Permalink</span><i class=\"fa fa-link\"></i>";
    anchor.title = "Permalink";
    return anchor;
  };
  var linkifyAnchors = function (level, containingElement) {
    var headers = containingElement.getElementsByTagName("h" + level);
    for (var h = 0; h < headers.length; h++) {
      var header = headers[h];
      if (typeof header.id !== "undefined" && header.id !== "") {
        header.prepend(anchorForId(header.id));
      }
    }
  };
  document.onreadystatechange = function () {
    if (this.readyState === "complete") {
      var contentBlock = document.getElementById("documentation");
      if (!contentBlock) {
        return;
      }
      for (var level = 1; level <= 6; level++) {
        linkifyAnchors(level, contentBlock);
      }
    }
  };
</script>


    <script src="/assets/app.js?v=1537994384"></script>

    <div id="fb-root"></div>

    <script src="https://2tjosk2rxzc21medji3nfn1g-wpengine.netdna-ssl.com/wp-content/themes/konghq/assets/js/vendor/bootstrap.min.js" async defer></script>

    <script id="github-bjs" src="https://buttons.github.io/buttons.js" async defer></script>
    <script id="twitter-wjs" type="text/javascript" src="https://platform.twitter.com/widgets.js" async defer></script>
    <script id="facebook-jssdk" type="text/javascript" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3&appId=842731852424506" async defer></script>

    <script type="text/javascript">
      piAId = '393112';
      piCId = '48375';

      (function() {
        function async_load(){
          var s = document.createElement('script'); s.type = 'text/javascript';
          s.src = ('https:' == document.location.protocol ? 'https://pi' : 'http://cdn') + '.pardot.com/pd.js';
          var c = document.getElementsByTagName('script')[0]; c.parentNode.insertBefore(s, c);
        }
        if(window.attachEvent) { window.attachEvent('onload', async_load); }
        else { window.addEventListener('load', async_load, false); }
      })();
    </script>

    <script type='text/javascript'>
      var _vwo_code=(function(){
      var account_id=125292,
      settings_tolerance=2000,
      library_tolerance=2500,
      use_existing_jquery=true,
      // DO NOT EDIT BELOW THIS LINE
      f=false,d=document;return{use_existing_jquery:function(){return use_existing_jquery;},library_tolerance:function(){return library_tolerance;},finish:function(){if(!f){f=true;var a=d.getElementById('_vis_opt_path_hides');if(a)a.parentNode.removeChild(a);}},finished:function(){return f;},load:function(a){var b=d.createElement('script');b.src=a;b.type='text/javascript';b.innerText;b.onerror=function(){_vwo_code.finish();};d.getElementsByTagName('head')[0].appendChild(b);},init:function(){settings_timer=setTimeout('_vwo_code.finish()',settings_tolerance);this.load('//dev.visualwebsiteoptimizer.com/j.php?a='+account_id+'&u='+encodeURIComponent(d.URL)+'&r='+Math.random());var a=d.createElement('style'),b='',h=d.getElementsByTagName('head')[0];a.setAttribute('id','_vis_opt_path_hides');a.setAttribute('type','text/css');if(a.styleSheet)a.styleSheet.cssText=b;else a.appendChild(d.createTextNode(b));h.appendChild(a);return settings_timer;}};}());_vwo_settings_timer=_vwo_code.init();
    </script>

    <script type="text/javascript">
      !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.0.1";
        analytics.load("WDj0nSS7hpyxwL3evgbOzK755s0NUye6");
        analytics.page()
      }}();
    </script>

  </body>


</html>
